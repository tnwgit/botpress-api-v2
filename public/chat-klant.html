<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Demo voor Klanten</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Importeer de chat styles -->
    <link rel="stylesheet" href="https://botpress-api-v2.vercel.app/css/chat-styles.css">
    <!-- Fallback naar relatief pad voor lokale ontwikkeling -->
    <link rel="stylesheet" href="/css/chat-styles.css">
    <!-- De originele chat.html styling behouden -->
    <style>
        /* Basis reset en algemene stijlen */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            background: #f5f5f5;
            overflow-x: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
            padding: 12px;
            min-height: 100vh;
        }

        /* Demo banner voor klanten */
        .demo-banner {
            background-color: #2C6BED;
            color: white;
            text-align: center;
            padding: 12px 15px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(44, 107, 237, 0.2);
            font-size: 15px;
        }

        /* Bot logo */
        .bot-logo {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 300px;
            margin: 0 auto 16px;
            padding: 0 10px;
        }

        .bot-logo img {
            height: 60px;
            width: auto;
            max-width: 100%;
            object-fit: contain;
        }

        /* Hoofdcontainer voor de chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
            flex: 1;
        }

        /* De container die zowel chat als suggesties bevat */
        .chat-with-suggestions {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 16px;
            flex: 1;
        }

        /* Berichtencontainer */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 200px;
            -webkit-overflow-scrolling: touch;
        }

        /* De kern chatbox */
        .chat-main {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            width: 100%;
            margin: 0;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            flex: 1;
        }

        /* Suggesties paneel */
        .suggestions-panel {
            width: 300px;
            min-width: 300px;
            max-width: 300px;
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: fit-content;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            align-self: flex-start;
            -webkit-overflow-scrolling: touch;
        }

        /* Header van de chatbox */
        .chat-header {
            background-color: var(--primary-color, #2C6BED);
            color: white;
            padding: 16px 20px;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 2;
        }

        .bot-name {
            font-size: 16px;
            font-weight: 600;
            color: white;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* Reset knop in header */
        .reset-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            transition: all 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .reset-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .reset-button:active {
            transform: scale(0.98);
        }

        /* Berichtbellen */
        .message {
            max-width: 85%;
            margin: 4px 0;
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.5;
            white-space: pre-wrap;
            animation: messageSlide 0.3s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message.user {
            background: var(--user-bubble, #2C6BED);
            color: var(--user-text, white);
            margin-left: auto;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }

        .message.bot {
            background: var(--bot-bubble, #f0f2f5);
            color: var(--bot-text, #1c1e21);
            margin-right: auto;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }

        /* Animaties */
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobiele aanpassingen */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .chat-with-suggestions {
                flex-direction: column;
            }

            .suggestions-panel {
                width: 100%;
                min-width: 100%;
                max-width: 100%;
                order: -1;
                max-height: none;
                margin-bottom: 12px;
            }

            .chat-main {
                height: 0;
                flex: 1;
            }

            .message {
                max-width: 90%;
                font-size: 14px;
                padding: 10px 14px;
            }

            .bot-logo {
                margin-bottom: 12px;
            }

            .bot-logo img {
                height: 50px;
            }

            .chat-messages {
                padding: 12px;
            }

            .chat-header {
                padding: 12px 16px;
            }

            .reset-button {
                padding: 6px 10px;
                font-size: 13px;
            }
        }

        /* Dark mode ondersteuning */
        @media (prefers-color-scheme: dark) {
            body {
                background: #1a1a1a;
            }

            .chat-main, .suggestions-panel {
                background: #2d2d2d;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            }

            .message.bot {
                background: #3a3a3a;
                color: #ffffff;
            }

            .bot-name {
                color: #ffffff;
            }
        }

        /* Basis reset en algemene stijlen */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background: #f5f5f5;
        }

        body {
            display: flex;
            flex-direction: column;
            padding: 20px;
            min-height: 100vh;
        }

        /* Demo banner voor klanten */
        .demo-banner {
            background-color: #2C6BED;
            color: white;
            text-align: center;
            padding: 8px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Bot logo */
        .bot-logo {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            padding: 0 10px;
        }

        .bot-logo img {
            height: 80px;
            width: auto;
            max-width: 100%;
            object-fit: contain;
        }

        /* Hoofdcontainer voor de chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            padding: 0;
            min-height: 500px;
        }

        /* De container die zowel chat als suggesties bevat */
        .chat-with-suggestions {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        /* Berichtencontainer - verwijder vaste hoogte en voeg auto-height toe */
        .chat-messages {
            flex: 1;
            overflow-y: visible;
            padding: 10px;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 200px;
        }

        /* De kern chatbox - verwijder vaste hoogte */
        .chat-main {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            width: 100%;
            margin: 0;
            box-sizing: border-box;
            position: relative;
        }

        /* Suggesties paneel - maak breder */
        .suggestions-panel {
            width: 400px;
            min-width: 400px;
            max-width: 400px;
            background: white;
            border-radius: 8px;
            padding: 18px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: auto;
            max-height: none;
            overflow-y: visible;
            align-self: flex-start;
        }

        /* Wanneer er geen suggesties zijn */
        .chat-with-suggestions:not(:has(.suggestions-panel:visible)) .chat-main,
        .chat-with-suggestions:not(:has(.suggestions-panel[style*="display: block"])) .chat-main {
            margin: 0 auto;
            max-width: 600px;
        }

        /* Header van de chatbox */
        .chat-header {
            background-color: var(--primary-color, #007bff);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1;
        }

        .bot-name {
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* Reset knop in header */
        .reset-button {
            background: transparent;
            border: none;
            padding: 5px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s;
        }

        .reset-button:hover {
            color: white;
        }

        /* Welkomstafbeelding */
        .welcome-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            padding: 10px;
            transition: all 0.5s ease;
            text-align: center;
        }

        .welcome-image-container img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
        }

        .welcome-image-container.hidden {
            display: none;
        }

        /* Berichtbellen */
        .message {
            max-width: 80%;
            margin: 5px;
            padding: 10px 12px;
            border-radius: 12px;
            word-wrap: break-word;
            display: inline-block;
            width: fit-content;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .message.user {
            background: var(--user-bubble, #007bff);
            color: var(--user-text, white);
            margin-left: auto;
            float: right;
            clear: both;
            border-bottom-right-radius: 4px;
        }

        .message.bot {
            background: var(--bot-bubble, #f8f9fa);
            color: var(--bot-text, #212529);
            margin-right: auto;
            float: left;
            clear: both;
            border-bottom-left-radius: 4px;
        }

        /* Typing indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 12px 18px;
            position: absolute;
            bottom: 80px;
            left: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .typing-indicator.visible {
            display: flex;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
            background: var(--primary-color, #007bff);
            opacity: 0.7;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
            opacity: 0.8;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
            opacity: 0.9;
        }

        @keyframes typingBounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-6px);
            }
        }

        /* Input gebied */
        .chat-input {
            display: flex;
            padding: 15px 20px;
            background-color: white;
            border-top: 1px solid rgba(0,0,0,0.05);
            align-items: flex-end;
            gap: 10px;
            position: relative;
            z-index: 1;
            border-radius: 0 0 8px 8px;
            box-sizing: border-box;
            width: 100%;
        }

        #message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 1rem;
            resize: none;
            height: 45px;
            min-height: 45px;
            max-height: 120px;
            line-height: 1.4;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: border-color 0.2s;
            font-family: inherit;
            box-sizing: border-box;
            width: calc(100% - 55px); /* Breedte van input = totale breedte - send button (45px) - gap (10px) */
        }
        
        #message-input::-webkit-scrollbar {
            display: none;
        }

        #message-input:focus {
            outline: none;
            border-color: var(--primary-color, #007bff);
        }

        /* Verzendknop */
        #send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: var(--primary-color, #007bff);
            color: white;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #send-btn:hover {
            transform: scale(1.05);
        }

        /* Suggestie buttons */
        .suggestions-panel h3 {
            margin-bottom: 15px;
            font-size: 1rem;
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .suggestion-button {
            padding: 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 10px;
            width: 100%;
        }

        .suggestion-button:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        /* Debug container */
        .debug-container {
            display: none;
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 300px;
            max-height: 300px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            z-index: 1000;
            overflow-y: auto;
        }

        .debug-container.visible {
            display: block;
        }

        .debug-log p {
            margin: 0;
            padding: 2px 0;
        }

        .debug-log p.error { color: #dc3545; }
        .debug-log p.success { color: #28a745; }
        .debug-log p.info { color: #17a2b8; }

        /* Responsieve aanpassingen */
        @media (max-width: 900px) {
            body {
                padding: 10px;
            }
            
            .chat-container {
                padding: 10px;
                height: calc(100vh - 140px);
            }
            
            .chat-with-suggestions {
                flex-direction: column;
            }

            .chat-main {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 100% !important;
                height: auto !important;
                min-height: 70vh !important;
                margin: 0 auto !important;
            }
            
            .suggestions-panel {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 100% !important;
                margin: 10px 0 0 0 !important;
                height: auto !important;
            }
            
            #bot-logo-img {
                max-height: 60px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .back-to-admin {
                top: 10px;
                left: 10px;
                padding: 5px 8px;
                font-size: 0.8em;
            }
            
            .bot-logo {
                margin-bottom: 10px;
            }
            
            #bot-logo-img {
                max-height: 50px;
            }
            
            .chat-container {
                padding: 5px;
                height: calc(100vh - 110px);
            }
            
            .chat-main {
                border-radius: 6px;
                height: auto !important;
                min-height: 80vh !important;
            }
            
            .chat-header {
                padding: 10px 15px;
            }
            
            .bot-name {
                font-size: 1.1em;
            }
            
            .message {
                max-width: 85%;
                font-size: 0.95em;
                padding: 8px 10px;
            }
            
            .chat-input {
                padding: 10px;
            }
            
            #message-input {
                padding: 10px;
                height: 40px;
                min-height: 40px;
                font-size: 0.95em;
            }
            
            #send-btn {
                width: 40px;
                height: 40px;
            }
            
            .welcome-image-container img {
                max-height: 120px;
            }
            
            .suggestions-panel {
                padding: 12px !important;
            }
            
            .suggestion-button {
                padding: 10px;
                font-size: 0.85em;
                margin-bottom: 8px;
            }
            
            .suggestions-panel h3 {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }
        }
        
        /* Fix voor kleine schermen en landschap oriëntatie */
        @media (max-height: 500px) {
            body {
                padding: 5px;
            }
            
            .bot-logo {
                margin-bottom: 10px;
            }
            
            #bot-logo-img {
                max-height: 40px;
            }
            
            .chat-container {
                height: calc(100vh - 80px);
                min-height: 300px;
            }
            
            .welcome-image-container img {
                max-height: 100px;
            }
            
            .chat-main {
                min-height: 300px !important;
            }
        }
        
        /* Touch device optimalisaties */
        @media (hover: none) {
            .suggestion-button {
                padding: 12px;
            }
            
            #message-input {
                font-size: 16px; /* Voorkomt inzoomen op iOS bij focus */
            }
            
            #send-btn {
                min-width: 44px; /* Verbeterde toegankelijkheid voor aanraakdoelen */
                min-height: 44px;
            }
        }

        /* Bot selector dropdown voor klanten */
        .bot-selector {
            margin: 0 auto 20px;
            max-width: 400px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .bot-selector label {
            font-weight: bold;
            color: #2C6BED;
        }

        .bot-selector select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        /* Error message when no botId is provided */
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .feedback-container {
            width: 100%;
            margin: 20px 0;
            box-sizing: border-box;
            max-width: 600px; /* Zelfde als chat-main */
            padding: 0;
        }

        .feedback-inner {
            width: 100%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            box-sizing: border-box;
        }
        
        .feedback-container h3 {
            margin: 0 0 15px 0;
            font-size: 1.2rem;
            color: #333;
        }
        
        .feedback-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .feedback-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .feedback-btn:hover {
            background-color: #e9ecef;
        }
        
        .feedback-btn.active {
            background-color: var(--primary-color, #2C6BED);
            color: white;
            border-color: var(--primary-color, #2C6BED);
        }
        
        .feedback-btn.active svg {
            stroke: white;
        }
        
        .feedback-text-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        #feedback-text {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        
        #submit-feedback {
            padding: 10px 15px;
            background-color: var(--primary-color, #2C6BED);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            align-self: flex-end;
            transition: all 0.2s;
        }
        
        #submit-feedback:hover {
            filter: brightness(1.1);
        }
        
        #feedback-msg {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .feedback-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .feedback-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        @media (max-width: 900px) {
            .page-layout {
                padding: 0 10px;
            }
            
            .feedback-inner {
                padding: 15px;
            }
        }
        
        @media (max-width: 600px) {
            .feedback-options {
                flex-direction: column;
                gap: 8px;
            }
            
            .feedback-btn {
                width: 100%;
                justify-content: center;
                padding: 10px;
            }
            
            #submit-feedback {
                width: 100%;
                align-self: center;
            }
        }
        
        @media (max-width: 480px) {
            .feedback-container {
                padding: 0 5px;
            }
            
            .feedback-inner {
                padding: 12px;
            }
        }

        /* Pagina container */
        .page-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            box-sizing: border-box;
        }

        /* Content wrapper voor centrering */
        .content-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            box-sizing: border-box;
            align-items: center;
        }
        
        /* De feedback container wordt uitgelijnd met de chat-main */
        .content-wrapper .feedback-container {
            max-width: 600px;
            margin-top: 20px;
            width: 100%;
        }

        /* Nieuwe grid layout styling */
        .page-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            box-sizing: border-box;
            align-items: center;
        }
        
        .chat-section, .feedback-section {
            width: 100%;
        }
        
        /* Force alignment tussen chat-main en feedback container */
        @media (min-width: 901px) {
            .page-layout {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            
            .chat-section {
                width: 100%;
                display: flex;
                justify-content: center;
            }
            
            .feedback-section {
                width: 100%;
                display: flex;
                justify-content: center;
                max-width: 600px;
            }
        }

        /* Nieuwe schone layout styling */
        .main-container {
            width: 900px;
            max-width: 900px;
            margin: 0 auto;
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        /* Chat rij styling */
        .chat-row {
            display: flex;
            justify-content: center;
            gap: 0;
        }
        
        /* Kolommen voor chat en suggesties */
        .chat-column {
            width: 600px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: auto;
            min-width: 600px; /* Voorkom krimpen */
        }

        .suggestions-column {
            width: 400px;
            margin-left: 10px;
        }
        
        /* Feedback container styling - nu direct in chat-column */
        .feedback-container {
            width: 100%;  /* Gebruikt volledige breedte van chat-column */
            margin: 0;  /* Reset margins */
        }
        
        .feedback-inner {
            width: 100%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            box-sizing: border-box;
        }
        
        /* Verwijder oude feedback-row styling */
        .feedback-row {
            display: none;  /* Verberg de oude feedback row */
        }
        
        /* Media queries voor responsiveness */
        @media (max-width: 900px) {
            .chat-row {
                flex-direction: column;
                align-items: center;
            }
            
            .chat-column, 
            .suggestions-column {
                width: 100%;
                max-width: 600px;
            }
            
            .feedback-row {
                padding-left: 0;
                justify-content: center;
            }
            
            .feedback-container {
                width: 100%;
                max-width: 600px;
            }
        }

        /* Feedback formulier styling */
        .feedback-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 10px;
            background: white;
            transition: border-color 0.2s;
        }

        .feedback-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        textarea.feedback-input {
            min-height: 100px;
            resize: vertical;
        }

        .feedback-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .feedback-message {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }

        .feedback-error {
            background-color: #fff3f3;
            color: #dc3545;
        }

        .feedback-success {
            background-color: #f0fff4;
            color: #28a745;
        }

        /* Rating container en buttons styling */
        .rating-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
        }

        .rating-btn {
            background: none;
            border: none;
            font-size: 24px;
            padding: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .rating-btn:hover {
            transform: scale(1.2);
            opacity: 1;
        }

        .rating-btn.selected {
            transform: scale(1.2);
            opacity: 1;
            position: relative;
        }

        .rating-btn.selected::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background-color: var(--primary-color);
            border-radius: 50%;
        }

        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-color, #2C6BED);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 18px;
            color: #333;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading indicator -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">De chat wordt geladen...</div>
    </div>

    <div class="demo-banner">
        Test je chat assistent
    </div>

    <div id="logo-container" class="bot-logo">
        <!-- Logo wordt dynamisch ingevoegd -->
        <img src="" alt="Bot Logo" id="bot-logo-img">
    </div>

    <div id="error-container" style="display:none;" class="error-message">
        Deze demonstratie vereist een geldige assistent-ID in de URL.
    </div>

    <!-- Nieuwe, schone layout structuur -->
    <div class="main-container">
        <!-- Rij voor chat en suggesties -->
        <div class="chat-row">
            <!-- Linker kolom: chat interface en feedback -->
            <div class="chat-column">
                <div class="chat-main" id="chat-main">
                    <div class="chat-header">
                        <div class="bot-name" id="botName">Laden...</div>
                        <div class="header-actions">
                            <button class="reset-button" id="reset-btn" title="Start een nieuw gesprek">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                    <path d="M3 3v5h5"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="chat-messages">
                        <div class="welcome-image-container" id="welcomeImageContainer">
                            <!-- Welkomstafbeelding wordt dynamisch ingevoegd -->
                        </div>
                        <!-- Berichten worden hier dynamisch toegevoegd -->
                    </div>
                    
                    <div class="typing-indicator" id="typing-indicator">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    
                    <div class="chat-input">
                        <textarea 
                            id="message-input" 
                            placeholder="Type je bericht..." 
                            rows="1"
                        ></textarea>
                        <button id="send-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Feedback panel direct in chat-column -->
                <div class="feedback-container" id="feedback-container">
                    <div class="feedback-inner">
                        <h3>Hoe was je ervaring?</h3>
                        <div class="rating-container">
                            <button class="rating-btn" data-rating="1">😞</button>
                            <button class="rating-btn" data-rating="2">😐</button>
                            <button class="rating-btn" data-rating="3">😊</button>
                            <button class="rating-btn" data-rating="4">😃</button>
                            <button class="rating-btn" data-rating="5">🤩</button>
                        </div>
                        <input type="text" id="feedback-name" placeholder="Je naam (optioneel)" class="feedback-input">
                        <textarea id="feedback-text" placeholder="Vertel ons meer over je ervaring (optioneel)" class="feedback-input"></textarea>
                        <div class="feedback-actions">
                            <button id="submit-feedback" class="primary-button">Verstuur feedback</button>
                        </div>
                        <p id="feedback-msg" class="feedback-message"></p>
                    </div>
                </div>
            </div>
            
            <!-- Rechter kolom: suggesties -->
            <div class="suggestions-column">
                <div class="suggestions-panel" id="suggestions-panel">
                    <h3>Veelgestelde vragen</h3>
                    <!-- Suggesties worden hier dynamisch toegevoegd -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Wacht tot het document geladen is
        document.addEventListener('DOMContentLoaded', async function() {
            // Haal botId uit URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const botId = urlParams.get('botId');
            
            if (!botId) {
                // Toon foutmelding als er geen botId is
                document.getElementById('error-container').style.display = 'block';
                console.error('Geen botId opgegeven in URL parameters');
                return;
            }
            
            try {
                // Haal bot informatie op
                const response = await fetch(`/api/bots/${botId}`);
                
                if (!response.ok) {
                    // Fallback: Check of er een botId in localStorage is
                    const cachedBotId = localStorage.getItem('botId');
                    const cachedBotName = localStorage.getItem('botName');
                    const cachedWebhookId = localStorage.getItem('currentWebhookId');
                    
                    if (cachedBotId === botId && cachedBotName && cachedWebhookId) {
                        console.log('Bot gegevens gevonden in cache');
                        
                        // Update titel
                        document.getElementById('botName').textContent = `Chat met ${cachedBotName}`;
                        document.title = `Chat met ${cachedBotName}`;
                        
                        // Laad en pas styling toe
                        await loadAndApplyStyling(botId);
                        
                        // Initialiseer chat
                        initChat();
                        return;
                    }
                    
                    throw new Error(`Bot niet gevonden: ${botId}`);
                }
                
                const botData = await response.json();
                
                // Sla gegevens op in localStorage
                localStorage.setItem('botId', botId);
                localStorage.setItem('botName', botData.name);
                localStorage.setItem('currentWebhookId', botData.webhook_id);
                
                // Update titel
                document.getElementById('botName').textContent = `Chat met ${botData.name}`;
                document.title = `Chat met ${botData.name}`;
                
                // Laad styling en initialiseer chat
                await loadAndApplyStyling(botId);
                initChat();
                
            } catch (error) {
                console.error('Fout bij laden assistent:', error);
                document.getElementById('error-container').style.display = 'block';
                document.getElementById('error-container').textContent = 
                    'Er is een fout opgetreden bij het laden van de assistent. Controleer of de ID in de URL correct is.';
            }
        });
        
        // Functie om bot styling op te halen en toe te passen
        async function loadAndApplyStyling(botId) {
            try {
                // Vraag styling op
                const styleResponse = await fetch(`/api/bot-styling/${botId}`);
                
                if (styleResponse.ok) {
                    const styling = await styleResponse.json();
                    
                    // Pas styling toe
                    applyBotStyling(styling);
                } else {
                    console.log('Geen specifieke styling gevonden voor deze bot');
                }
            } catch (error) {
                console.error('Fout bij laden styling:', error);
            }
        }
        
        // Functie om bot styling toe te passen
        function applyBotStyling(styling) {
            if (!styling) return;
            
            try {
                // Check of styling genest is in een 'styling' property (vaak het geval)
                const styleData = styling.styling || styling;
                console.log('Toepassen van styling:', styleData);
                
                // Algemene stijl
                if (styleData.general) {
                    // Font family
                    if (styleData.general.fontFamily) {
                        document.body.style.fontFamily = styleData.general.fontFamily;
                    }
                    
                    // Titel
                    if (styleData.general.title) {
                        document.getElementById('botName').textContent = styleData.general.title;
                    }
                    
                    // Logo
                    if (styleData.general.logo) {
                        const logoImg = document.getElementById('bot-logo-img');
                        logoImg.src = styleData.general.logo;
                        logoImg.style.display = 'block';
                    }
                    
                    // Welkomstafbeelding
                    if (styleData.general.welcomeImage) {
                        const welcomeContainer = document.getElementById('welcomeImageContainer');
                        welcomeContainer.innerHTML = '';
                        
                        const img = document.createElement('img');
                        img.src = styleData.general.welcomeImage;
                        img.alt = 'Welkom';
                        welcomeContainer.appendChild(img);
                    }
                }
                
                // Kleuren
                if (styleData.colors) {
                    const header = document.querySelector('.chat-header');
                    header.style.backgroundColor = styleData.colors.primary;
                    
                    // Text kleuren
                    if (styleData.colors.titleText) {
                        document.getElementById('botName').style.color = styleData.colors.titleText;
                    }
                    
                    // CSS variabelen voor kleuren
                    document.documentElement.style.setProperty('--primary-color', styleData.colors.primary);
                    
                    // Styling voor berichten
                    const styleEl = document.createElement('style');
                    styleEl.textContent = `
                        .message.user {
                            background-color: ${styleData.colors.userBubble || styleData.colors.primary};
                            color: ${styleData.colors.userText || 'white'};
                        }
                        .message.bot {
                            background-color: ${styleData.colors.botBubble || '#f8f9fa'};
                            color: ${styleData.colors.botText || '#212529'};
                        }
                        #send-btn {
                            background-color: ${styleData.colors.primary};
                        }
                    `;
                    document.head.appendChild(styleEl);
                }
                
                // Text placeholders
                if (styleData.text && styleData.text.placeholderText) {
                    document.getElementById('message-input').placeholder = styleData.text.placeholderText;
                }
                
                // Suggesties
                if (styleData.suggestions && Array.isArray(styleData.suggestions)) {
                    const suggestionsPanel = document.getElementById('suggestions-panel');
                    suggestionsPanel.innerHTML = '<h3>Veelgestelde vragen</h3>';
                    
                    // Toon suggesties panel op basis van dimensie-instelling
                    const showSuggestionsPanel = styleData.dimensions?.showSuggestionsPanel !== false;
                    
                    if (styleData.suggestions.length > 0 && showSuggestionsPanel) {
                        styleData.suggestions.forEach(suggestion => {
                            const btn = document.createElement('button');
                            btn.className = 'suggestion-button';
                            btn.textContent = suggestion;
                            btn.onclick = function() {
                                document.getElementById('message-input').value = suggestion;
                                document.getElementById('send-btn').click();
                            };
                            suggestionsPanel.appendChild(btn);
                        });
                        // Toon het suggestiepaneel
                        suggestionsPanel.style.display = 'block';
                        } else {
                        // Verberg suggesties paneel als er geen suggesties zijn of als showSuggestionsPanel false is
                        suggestionsPanel.style.display = 'none';
                        }
                    } else {
                    // Verberg suggesties paneel als er geen suggesties property is
                    document.getElementById('suggestions-panel').style.display = 'none';
                }
                
                // Afmetingen
                if (styleData.dimensions) {
                    const chatMain = document.querySelector('.chat-main');
                    const chatMessages = document.querySelector('.chat-messages');
                    const chatWithSuggestions = document.querySelector('.chat-with-suggestions');
                    const suggestionsPanel = document.getElementById('suggestions-panel');
                    const feedbackInner = document.querySelector('.feedback-inner');
                    const chatColumn = document.querySelector('.chat-column');
                    const typingIndicator = document.querySelector('.typing-indicator');
                    
                    // Pas afmetingen toe
                    let chatWidth = 600; // Standaard breedte
                    let chatHeight = 600; // Standaard hoogte
                    
                    if (styleData.dimensions.chatHeight) {
                        chatHeight = parseInt(styleData.dimensions.chatHeight) || 600;
                    }
                    
                    if (styleData.dimensions.chatWidth) {
                        chatWidth = parseInt(styleData.dimensions.chatWidth) || 600;
                        
                        // Pas de breedte van de chat kolom aan
                        if (chatColumn) {
                            chatColumn.style.width = `${chatWidth}px`;
                            chatColumn.style.minWidth = `${chatWidth}px`; // Voorkom krimpen
                        }
                        
                        // Pas de chat main container aan
                        if (chatMain) {
                            chatMain.style.width = '100%';
                        }
                        
                        // Pas ook de breedte van het feedback panel aan
                        if (feedbackInner) {
                            feedbackInner.style.width = '100%';
                        }
                    }
                    
                    // Pas de kleur van de typing indicator aan
                    if (styleData.colors && styleData.colors.primary && typingIndicator) {
                        const dots = typingIndicator.querySelectorAll('.dot');
                        dots.forEach(dot => {
                            dot.style.background = styleData.colors.primary;
                        });
                    }
                    
                    // Stel initiële hoogte in
                    if (chatMain) {
                        chatMain.style.height = `${chatHeight}px`;
                        chatMain.style.minHeight = `${chatHeight}px`;
                    }
                    
                    if (chatMessages) {
                        // Trek de hoogte van header (60px) en input gebied (75px) af
                        const messageAreaHeight = chatHeight - 135;
                        chatMessages.style.height = `${messageAreaHeight}px`;
                        chatMessages.style.minHeight = `${messageAreaHeight}px`;
                    }
                }
                
                // Maak de layout responsief
                const dimStyleEl = document.createElement('style');
                dimStyleEl.setAttribute('data-dimensions', 'bot-custom');
                
                // Voeg media queries toe voor responsieve layout
                dimStyleEl.textContent = `
                    @media (max-width: 900px) {
                        .chat-main {
                            width: 100% !important;
                            max-width: 100% !important;
                            min-width: 100% !important;
                        }
                    }
                `;
                
                document.head.appendChild(dimStyleEl);
                
                console.log('Bot styling succesvol toegepast');
            } catch (error) {
                console.error('Fout bij toepassen styling:', error);
            }
        }
        
        // Chat initialisatie
        function initChat() {
            // Event listeners voor chat interactie
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-btn');
            const resetButton = document.getElementById('reset-btn');
            
            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = '40px';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // Verzend bericht bij klikken op verzendknop
            sendButton.addEventListener('click', function() {
                const text = messageInput.value.trim();
                if (text) {
                    sendUserMessage(text);
            messageInput.value = '';
            messageInput.style.height = '40px';
                }
            });
            
            // Verzend bericht bij drukken op Enter (zonder Shift)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendButton.click();
                }
            });
            
            // Reset chat bij klikken op reset knop
            resetButton.addEventListener('click', resetChat);
            
            // Initialiseer de chat sessie
            initializeChat();
        }
        
        // Stuur een gebruikersbericht
        async function sendUserMessage(text) {
            try {
                // Haal gegevens op uit localStorage
                const webhookId = localStorage.getItem('currentWebhookId');
                const botId = localStorage.getItem('botId');
                let userId = localStorage.getItem('userId');
                let userKey = localStorage.getItem('userKey');
                let conversationId = localStorage.getItem('conversationId');
                
                if (!webhookId || !botId) {
                    throw new Error('Geen geldige bot gegevens beschikbaar');
                }
                
                // Voeg bericht toe aan UI
                addMessageToUI(text, 'user');
            
            // Toon typing indicator
                showTypingIndicator();
                
                // Als we nog geen gebruiker of conversatie hebben, maak deze aan
                if (!userId || !userKey || !conversationId) {
                    await initializeChat();
                    userId = localStorage.getItem('userId');
                    userKey = localStorage.getItem('userKey');
                    conversationId = localStorage.getItem('conversationId');
                }
                
                // Creëer client voor deze aanvraag
                const client = new BotpressChatClient({
                    webhookId: extractWebhookId(webhookId.trim())
                });
                
                // Stuur bericht direct via de client
                await client.sendMessage({
                    userId,
                    userKey,
                    conversationId,
                    payload: {
                        type: 'text',
                        text
                    }
                });
                
                // Controleer na 500ms of de typing indicator nog getoond moet worden
                setTimeout(checkTypingIndicator, 500);
                
                // Wacht op antwoord via polling
                pollForMessages();
                
            } catch (error) {
                console.error('Fout bij versturen bericht:', error);
                hideTypingIndicator();
                addMessageToUI('Er is een fout opgetreden bij het versturen van je bericht. Probeer het opnieuw.', 'bot');
            }
        }
        
        // Voeg bericht toe aan UI
        function addMessageToUI(text, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const welcomeImage = document.getElementById('welcomeImageContainer');
            
            // Verberg welkomstafbeelding bij gebruikersberichten
            if (sender === 'user' && welcomeImage) {
                welcomeImage.style.display = 'none';
            }
            
            // Maak bericht element
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // Sanitize en render markdown voor bot berichten
            if (sender === 'bot') {
                // Gebruik DOMPurify en marked voor veilige markdown rendering
                const sanitizedHtml = DOMPurify.sanitize(marked.parse(text));
                messageDiv.innerHTML = sanitizedHtml;
            } else {
                // Plain text voor gebruiker berichten
                messageDiv.textContent = text;
            }
            
            // Voeg bericht toe
            messagesContainer.appendChild(messageDiv);
            
            // Scroll logica
            if (sender === 'bot') {
                // Voor bot berichten, scroll zodat zowel de laatste gebruikersvraag als het begin van het antwoord zichtbaar zijn
                const lastUserMessage = messagesContainer.querySelector('.message.user:last-of-type');
                if (lastUserMessage) {
                    const lastUserMessageTop = lastUserMessage.offsetTop;
                    messagesContainer.scrollTop = Math.max(0, lastUserMessageTop - 60); // 60px ruimte boven de vraag
                }
            } else {
                // Voor gebruikersberichten, scroll naar beneden
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        // Initialiseer chat
        async function initializeChat() {
            try {
                // Haal gegevens op uit localStorage
                const webhookId = localStorage.getItem('currentWebhookId');
                const botId = localStorage.getItem('botId');
                
                if (!webhookId || !botId) {
                    throw new Error('Geen geldige bot gegevens beschikbaar');
                }
                
                console.log('Initialiseren chat met webhook ID:', webhookId);
                
                // Creëer een Botpress client
                const client = new BotpressChatClient({
                    webhookId: extractWebhookId(webhookId.trim())
                });
                
                // Maak een nieuwe gebruiker
                const userResult = await client.createUser({
                    name: `User-${Date.now()}`,
                    tags: { source: 'web-client' }
                });
                
                const userId = userResult.user.id;
                const userKey = userResult.key;
                
                console.log('Gebruiker aangemaakt:', userId, userKey);
                
                // Sla gebruikersgegevens op
                localStorage.setItem('userId', userId);
                localStorage.setItem('userKey', userKey);
                
                // Maak een conversatie aan direct met de client
                try {
                    const conversation = await client.createConversation({
                        userId,
                        userKey
                    });
                    
                    localStorage.setItem('conversationId', conversation.id);
                    console.log('Conversatie aangemaakt:', conversation.id);
                } catch (convError) {
                    console.error('Fout bij aanmaken conversatie:', convError);
                    throw new Error(`Kon geen conversatie aanmaken: ${convError.message}`);
                }
                
                // Verberg error container als alles succesvol is
                document.getElementById('error-container').style.display = 'none';
                
            } catch (error) {
                console.error('Fout bij initialiseren chat:', error);
                document.getElementById('error-container').style.display = 'block';
                document.getElementById('error-container').textContent = 
                    `Er is een fout opgetreden bij het initialiseren van de chat: ${error.message}\n\nProbeer de pagina te vernieuwen.`;
            }
        }
        
        // Reset chat
        async function resetChat() {
            try {
                // Haal gegevens op uit localStorage
                const userId = localStorage.getItem('userId');
                const userKey = localStorage.getItem('userKey');
                const conversationId = localStorage.getItem('conversationId');
                const webhookId = localStorage.getItem('currentWebhookId');
                
                if (!userId || !userKey || !conversationId || !webhookId) {
                    throw new Error('Geen geldige chat gegevens beschikbaar');
                }
                
                // Wis chat geschiedenis
                document.getElementById('chat-messages').innerHTML = `
                    <div class="welcome-image-container" id="welcomeImageContainer"></div>
                `;
                
                // Creëer client voor deze aanvraag
                const client = new BotpressChatClient({
                    webhookId: extractWebhookId(webhookId.trim())
                });
                
                // Verwijder de huidige conversatie
                try {
                await client.deleteConversation({
                    userId,
                    userKey,
                    conversationId
                });
                    console.log('Vorige conversatie verwijderd');
                } catch (error) {
                    console.error('Fout bij verwijderen conversatie:', error);
                    // We gaan toch door met een nieuwe conversatie maken
                }
                
                // Wis localStorage conversatie data
                localStorage.removeItem('conversationId');
                
                // Maak een nieuwe conversatie aan
                const conversationResult = await client.createConversation({
                    userId,
                    userKey
                });
                
                // Sla de nieuwe conversatie ID op
                localStorage.setItem('conversationId', conversationResult.id);
                console.log('Nieuwe conversatie aangemaakt:', conversationResult.id);
                
                // Laad styling opnieuw voor welkomstafbeelding
                const botId = localStorage.getItem('botId');
                await loadAndApplyStyling(botId);
                
            } catch (error) {
                console.error('Fout bij resetten chat:', error);
                addMessageToUI('Er is een fout opgetreden bij het herstarten van de chat. Probeer de pagina te vernieuwen.', 'bot');
            }
        }
        
        // Toon typing indicator
        function showTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.classList.add('visible');
                
                // Scroll naar beneden
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        // Verberg typing indicator
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.classList.remove('visible');
            }
        }
        
        // Controleer of typing indicator nog getoond moet worden
        function checkTypingIndicator() {
            // Als we na 500ms nog geen antwoord hebben, verberg de indicator
            // Dit zorgt ervoor dat de indicator niet oneindig blijft staan bij een fout
            const lastMessage = document.querySelector('.message:last-child');
            if (lastMessage && lastMessage.classList.contains('user')) {
                // Als het laatste bericht van de gebruiker is, toon typing indicator
                showTypingIndicator();
            } else {
                // Anders verberg de indicator
                hideTypingIndicator();
            }
        }
        
        // Poll voor nieuwe berichten
        let isPolling = false;
        let pollingInterval;
        let lastProcessedMessageIds = [];
        
        function pollForMessages() {
            if (isPolling) return;
            
            isPolling = true;
            clearInterval(pollingInterval);
            
            // Toon typing indicator direct
            showTypingIndicator();
            
            pollingInterval = setInterval(async () => {
                try {
                    // Haal chat gegevens op
                    const userId = localStorage.getItem('userId');
                    const userKey = localStorage.getItem('userKey');
                    const conversationId = localStorage.getItem('conversationId');
                    const webhookId = localStorage.getItem('currentWebhookId');
                    
                    if (!userId || !userKey || !conversationId || !webhookId) {
                        clearInterval(pollingInterval);
                        isPolling = false;
                        hideTypingIndicator();
                        return;
                    }
                    
                    // Creëer client voor deze aanvraag
                    const client = new BotpressChatClient({
                        webhookId: extractWebhookId(webhookId.trim())
                    });
                    
                    // Haal berichten op direct via de client
                    const messages = await client.listMessages({
                        conversationId,
                        userId,
                        userKey
                    });
                    
                    // Verwerk eventuele nieuwe berichten
                    if (messages && messages.length > 0) {
                        // Filter nieuwe berichten van de bot (niet van onszelf)
                        const newBotMessages = messages.filter(msg => {
                            // Check of we dit bericht al hebben verwerkt
                            if (lastProcessedMessageIds.includes(msg.id)) {
                                return false;
                            }
                            
                            // Voeg toe aan verwerkte berichten
                            lastProcessedMessageIds.push(msg.id);
                            
                            // Bepaal of het een bot bericht is
                            return msg.direction === 'incoming' || 
                                  msg.userId !== userId ||
                                  (msg.payload && msg.payload.type === 'bot');
                        });
                        
                        // Als er nieuwe berichten zijn
                        if (newBotMessages.length > 0) {
                            // Verberg typing indicator
                            hideTypingIndicator();
                            
                            // Voeg nieuwe berichten toe aan de UI
                            for (const msg of newBotMessages) {
                                const messageText = msg.payload?.text || 'Geen tekst beschikbaar';
                                addMessageToUI(messageText, 'bot');
                            }
                            
                            // Stop polling na laatste bericht
                            clearInterval(pollingInterval);
                            isPolling = false;
                        }
                    }
                    
                } catch (error) {
                    console.error('Fout bij ophalen berichten:', error);
                    clearInterval(pollingInterval);
                    isPolling = false;
                    hideTypingIndicator();
                }
            }, 1000);
            
            // Stop polling en verberg indicator na 30 seconden als er geen antwoord is
            setTimeout(() => {
                if (isPolling) {
                    clearInterval(pollingInterval);
                    isPolling = false;
                    hideTypingIndicator();
                    addMessageToUI('Sorry, ik kon geen antwoord genereren. Probeer het opnieuw.', 'bot');
                }
            }, 30000);
        }

        // Voeg BotpressChat client class toe bovenaan script

        class BotpressChatClient {
            constructor(config) {
                this.webhookId = config.webhookId;
                this.baseUrl = 'https://chat.botpress.cloud';
            }
            
            async checkConnection() {
                try {
                    const response = await fetch(`${this.baseUrl}/${this.webhookId}/hello`);
                    if (!response.ok) {
                        throw new Error(`Error: ${response.status} ${response.statusText}`);
                    }
                    return await response.text();
                } catch (error) {
                    throw new Error(`Connection error: ${error.message}`);
                }
            }
            
            async createUser(options = {}) {
                try {
                    const response = await fetch(`${this.baseUrl}/${this.webhookId}/users`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: options.name || `User-${Date.now()}`,
                            ...(options.tags && { tags: options.tags })
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`Error creating user: ${JSON.stringify(error)}`);
                    }
                    
                    const data = await response.json();
                    
                    // Extraheer het user ID uit de JWT token indien mogelijk
                    let userId = null;
                    if (data && data.key) {
                        try {
                            const tokenParts = data.key.split('.');
                            if (tokenParts.length >= 2) {
                                const tokenPayload = atob(tokenParts[1].replace(/-/g, '+').replace(/_/g, '/'));
                                const payloadObj = JSON.parse(tokenPayload);
                                userId = payloadObj.id;
                            }
                        } catch (e) {
                            console.error('Kon user ID niet uit token halen:', e);
                        }
                    }
                    
                    // Gebruik het gevonden ID of een fallback
                    userId = userId || data.id || 'unknown_user_id';
                    const userKey = data.key || '';
                    
                    return {
                        user: { id: userId },
                        key: userKey
                    };
                } catch (error) {
                    throw new Error(`Error creating user: ${error.message}`);
                }
            }
            
            async createConversation(options) {
                try {
                    const response = await fetch(`${this.baseUrl}/${this.webhookId}/conversations`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-user-id': options.userId,
                            'x-user-key': options.userKey
                        },
                        body: JSON.stringify({}) // Lege body zoals in de documentatie
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`Error creating conversation: ${JSON.stringify(error)}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.id) {
                        // Probeer een ID te vinden in de response
                        let conversationId = null;
                        if (data && typeof data === 'object') {
                            for (const key in data) {
                                if (key.toLowerCase() === 'id') {
                                    conversationId = data[key];
                                    break;
                                }
                            }
                            
                            if (!conversationId) {
                                for (const key in data) {
                                    if (typeof data[key] === 'object' && data[key] !== null && data[key].id) {
                                        conversationId = data[key].id;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        if (conversationId) {
                            return { id: conversationId };
                        }
                        
                        throw new Error('Kon geen conversatie ID vinden in de response');
                    }
                    
                    return data;
                } catch (error) {
                    throw new Error(`Error creating conversation: ${error.message}`);
                }
            }
            
            async sendMessage(options) {
                try {
                    const response = await fetch(`${this.baseUrl}/${this.webhookId}/messages`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-user-id': options.userId,
                            'x-user-key': options.userKey
                        },
                        body: JSON.stringify({
                            conversationId: options.conversationId,
                            payload: {
                                type: options.payload.type || 'text',
                                text: options.payload.text
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`Error sending message: ${JSON.stringify(error)}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    throw new Error(`Error sending message: ${error.message}`);
                }
            }
            
            async listMessages(options) {
                try {
                    const response = await fetch(`${this.baseUrl}/${this.webhookId}/conversations/${options.conversationId}/messages`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-user-id': options.userId,
                            'x-user-key': options.userKey
                        }
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`Error listing messages: ${JSON.stringify(error)}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!Array.isArray(data)) {
                        if (data && typeof data === 'object' && Array.isArray(data.messages)) {
                            return data.messages;
                        }
                        
                        if (data && typeof data === 'object' && Array.isArray(data.results)) {
                            return data.results;
                        }
                        
                        return []; // Retourneer een lege array
                    }
                    
                    return data;
                } catch (error) {
                    throw new Error(`Error listing messages: ${error.message}`);
                }
            }
            
            async deleteConversation(options) {
                try {
                    const response = await fetch(`${this.baseUrl}/${this.webhookId}/conversations/${options.conversationId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-user-id': options.userId,
                            'x-user-key': options.userKey
                        }
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`Error deleting conversation: ${JSON.stringify(error)}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    throw new Error(`Error deleting conversation: ${error.message}`);
                }
            }
        }

        // Hulpfunctie om webhook ID te extraheren
        function extractWebhookId(url) {
            if (!url) return null;
            
            if (url.includes('webhook.botpress.cloud/')) {
                return url.split('webhook.botpress.cloud/')[1];
            }
            
            if (url.includes('chat.botpress.cloud/')) {
                return url.split('chat.botpress.cloud/')[1];
            }
            
            if (url.startsWith('http') && url.includes('/')) {
                const parts = url.split('/');
                return parts[parts.length - 1];
            }
            
            return url;
        }

        // Feedback functionaliteit
        const feedbackBtns = document.querySelectorAll('.rating-btn');
        const feedbackText = document.getElementById('feedback-text');
        const submitFeedbackBtn = document.getElementById('submit-feedback');
        const feedbackMsg = document.getElementById('feedback-msg');
        let selectedRating = null;
        
        // Event listeners voor feedback knoppen
        feedbackBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Verwijder actieve klasse van alle knoppen
                feedbackBtns.forEach(b => b.classList.remove('selected'));
                // Voeg actieve klasse toe aan geselecteerde knop
                btn.classList.add('selected');
                // Sla numerieke rating op
                selectedRating = parseInt(btn.dataset.rating);
            });
        });
        
        // Event listener voor versturen feedback
        submitFeedbackBtn.addEventListener('click', async () => {
            if (!selectedRating) {
                feedbackMsg.textContent = "Selecteer eerst een waardering";
                feedbackMsg.className = "feedback-error";
                return;
            }
            
            try {
                const botId = localStorage.getItem('botId');
                const userId = localStorage.getItem('userId');
                const conversationId = localStorage.getItem('conversationId');
                const name = document.getElementById('feedback-name').value.trim();
                
                // Verzamel alle berichten uit de chat
                const chatMessages = document.querySelectorAll('.message');
                const chatHistory = Array.from(chatMessages).map(msg => {
                    const isUser = msg.classList.contains('user');
                    return {
                        type: isUser ? 'user' : 'bot',
                        text: msg.textContent || ''
                    };
                });

                // Verstuur data naar Google Apps Script web app
                const response = await fetch('https://script.google.com/macros/s/AKfycby_hi7XVldGvbVmJISB3YdoXgnhbykJMnjutl3m2i77KLY1aYNzKejlQPjkdsuTC5Xh/exec', {
                    method: 'POST',
                    mode: 'no-cors', // Belangrijk voor cross-origin requests
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        botId,
                        name: name || 'Anoniem',
                        rating: selectedRating,
                        comment: feedbackText.value.trim(),
                        userId,
                        conversationId,
                        chatHistory: JSON.stringify(chatHistory)
                    })
                });
                
                // Toon success message
                feedbackMsg.textContent = "Bedankt voor je feedback!";
                feedbackMsg.className = "feedback-success";
                
                // Reset het formulier
                selectedRating = null;
                document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('selected'));
                document.getElementById('feedback-name').value = '';
                feedbackText.value = '';
                
            } catch (error) {
                console.error('Fout bij versturen feedback:', error);
                feedbackMsg.textContent = "Er ging iets mis bij het versturen van je feedback";
                feedbackMsg.className = "feedback-error";
            }
        });

        // Functie om de loading overlay te verbergen
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 500);
            }
        }
        
        // Wacht tot alles geladen is voordat de loading indicator wordt verborgen
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialisatie van de pagina (bestaande logica)
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const botId = urlParams.get('botId');
                
                if (!botId) {
                    throw new Error('Geen bot ID opgegeven');
                }
                
                // Sla bot ID op in localStorage
                localStorage.setItem('botId', botId);
                
                // Haal bot informatie op
                const response = await fetch(`/api/bots/${botId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const bot = await response.json();
                
                // Sla webhook ID op
                localStorage.setItem('currentWebhookId', bot.webhook_id);
                
                // Stel bot naam in
                const botNameElement = document.getElementById('bot-name');
                if (botNameElement) {
                    botNameElement.textContent = bot.name || 'Chat Bot';
                }
                
                // Controleer en pas styling toe
                if (bot.styling) {
                    await applyBotStyling(bot.styling);
                }
                
                // Initialiseer de chat
                await initChat();
                
                // Verberg de loading overlay nadat alles is geladen
                hideLoadingOverlay();
                
            } catch (error) {
                console.error('Fout bij initialiseren van de pagina:', error);
                document.getElementById('error-container').textContent = 
                    `Er is een fout opgetreden bij het laden van de chat: ${error.message}`;
                document.getElementById('error-container').style.display = 'block';
                
                // Verberg de loading overlay, zelfs als er een fout is
                hideLoadingOverlay();
            }
        });
    </script>
</body>
</html> 