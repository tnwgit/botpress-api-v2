<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat met Assistent</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Importeer de chat styles -->
    <link rel="stylesheet" href="https://botpress-api-v2.vercel.app/css/chat-styles.css">
    <!-- Fallback naar relatief pad voor lokale ontwikkeling -->
    <link rel="stylesheet" href="/css/chat-styles.css">
    <!-- De originele chat.html styling behouden -->
    <style>
        /* Basis reset en algemene stijlen */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background: #f5f5f5;
        }

        body {
            display: flex;
            flex-direction: column;
            padding: 20px;
            min-height: 100vh;
        }

        /* Terug naar admin knop */
        .back-to-admin {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            color: #6c757d;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 100;
            text-decoration: none;
        }

        /* Bot logo */
        .bot-logo {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            padding: 0 10px;
        }

        .bot-logo img {
            height: 80px;
            width: auto;
            max-width: 100%;
            object-fit: contain;
        }

        /* Hoofdcontainer voor de chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            margin: 0 auto;
            max-width: 1200px;
            width: 100%;
            padding: 20px;
            flex: 1;
            min-height: 600px;
            height: calc(100vh - 180px);
        }

        /* De container die zowel chat als suggesties bevat */
        .chat-with-suggestions {
            display: flex;
            width: 100%;
            height: 100%;
            gap: 10px;
        }

        /* De kern chatbox */
        .chat-main {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
            min-width: 350px;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Suggesties paneel naast de chat */
        .suggestions-panel {
            width: 300px;
            min-width: 280px;
            background: white;
            border-radius: 8px;
            padding: 18px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: auto;
            max-height: none;
            overflow-y: visible;
            align-self: flex-start;
        }

        /* Wanneer er geen suggesties zijn */
        .chat-with-suggestions:not(:has(.suggestions-panel:visible)) .chat-main,
        .chat-with-suggestions:not(:has(.suggestions-panel[style*="display: block"])) .chat-main {
            margin: 0 auto;
            max-width: 600px;
        }

        /* Header van de chatbox */
        .chat-header {
            background-color: var(--primary-color, #007bff);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1;
        }

        .bot-name {
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* Reset knop in header */
        .reset-button {
            background: transparent;
            border: none;
            padding: 5px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s;
        }

        .reset-button:hover {
            color: white;
        }

        /* Berichtencontainer */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            position: relative;
        }

        /* Welkomstafbeelding */
        .welcome-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            padding: 10px;
            transition: all 0.5s ease;
            text-align: center;
        }

        .welcome-image-container img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
        }

        .welcome-image-container.hidden {
            display: none;
        }

        /* Berichtbellen */
        .message {
            max-width: 80%;
            margin: 5px;
            padding: 10px 12px;
            border-radius: 12px;
            word-wrap: break-word;
            display: inline-block;
            width: fit-content;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .message.user {
            background: var(--user-bubble, #007bff);
            color: var(--user-text, white);
            margin-left: auto;
            float: right;
            clear: both;
            border-bottom-right-radius: 4px;
        }

        .message.bot {
            background: var(--bot-bubble, #f8f9fa);
            color: var(--bot-text, #212529);
            margin-right: auto;
            float: left;
            clear: both;
            border-bottom-left-radius: 4px;
        }

        /* Typing indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 5px;
            padding: 10px;
            color: #6c757d;
        }

        .typing-indicator.visible {
            display: flex;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #6c757d;
            border-radius: 50%;
            animation: bounce 1.3s linear infinite;
        }

        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Input gebied */
        .chat-input {
            display: flex;
            padding: 15px;
            background-color: white;
            border-top: 1px solid rgba(0,0,0,0.05);
            align-items: flex-end;
            gap: 10px;
            position: relative;
            z-index: 1;
            border-radius: 0 0 8px 8px;
        }

        #message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 1rem;
            resize: none;
            height: 45px;
            min-height: 45px;
            max-height: 120px;
            line-height: 1.4;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        #message-input::-webkit-scrollbar {
            display: none;
        }

        #message-input:focus {
            outline: none;
            border-color: var(--primary-color, #007bff);
        }

        /* Verzendknop */
        #send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: var(--primary-color, #007bff);
            color: white;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #send-btn:hover {
            transform: scale(1.05);
        }

        /* Suggestie buttons */
        .suggestions-panel h3 {
            margin-bottom: 15px;
            font-size: 1rem;
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .suggestion-button {
            padding: 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 10px;
            width: 100%;
        }

        .suggestion-button:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        /* Debug container */
        .debug-container {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            max-height: 30vh;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
        }

        .debug-container.visible {
            display: block;
        }

        .debug-log p {
            margin: 0;
            padding: 2px 0;
        }

        .debug-log p.error { color: #dc3545; }
        .debug-log p.success { color: #28a745; }
        .debug-log p.info { color: #17a2b8; }

        /* Responsieve aanpassingen */
        @media (max-width: 900px) {
            body {
                padding: 10px;
            }
            
            .chat-container {
                padding: 10px;
                height: calc(100vh - 140px);
            }
            
            .chat-with-suggestions {
                flex-direction: column;
            }
            
            .chat-main {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 100% !important;
                height: auto !important;
                min-height: 70vh !important;
                margin: 0 auto !important;
            }
            
            .suggestions-panel {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 100% !important;
                margin: 10px 0 0 0 !important;
                height: auto !important;
            }
            
            #bot-logo-img {
                max-height: 60px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .back-to-admin {
                top: 10px;
                left: 10px;
                padding: 5px 8px;
                font-size: 0.8em;
            }
            
            .bot-logo {
                margin-bottom: 10px;
            }
            
            #bot-logo-img {
                max-height: 50px;
            }
            
            .chat-container {
                padding: 5px;
                height: calc(100vh - 110px);
            }
            
            .chat-main {
                border-radius: 6px;
                height: auto !important;
                min-height: 80vh !important;
            }
            
            .chat-header {
                padding: 10px 15px;
            }
            
            .bot-name {
                font-size: 1.1em;
            }
            
            .message {
                max-width: 85%;
                font-size: 0.95em;
                padding: 8px 10px;
            }
            
            .chat-input {
                padding: 10px;
            }
            
            #message-input {
                padding: 10px;
                height: 40px;
                min-height: 40px;
                font-size: 0.95em;
            }
            
            #send-btn {
                width: 40px;
                height: 40px;
            }
            
            .welcome-image-container img {
                max-height: 120px;
            }
            
            .suggestions-panel {
                padding: 12px !important;
            }
            
            .suggestion-button {
                padding: 10px;
                font-size: 0.85em;
                margin-bottom: 8px;
            }
            
            .suggestions-panel h3 {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }
        }
        
        /* Fix voor kleine schermen en landschap oriëntatie */
        @media (max-height: 500px) {
            body {
                padding: 5px;
            }
            
            .bot-logo {
                margin-bottom: 10px;
            }
            
            #bot-logo-img {
                max-height: 40px;
            }
            
            .chat-container {
                height: calc(100vh - 80px);
                min-height: 300px;
            }
            
            .welcome-image-container img {
                max-height: 100px;
            }
            
            .chat-main {
                min-height: 300px !important;
            }
        }
        
        /* Touch device optimalisaties */
        @media (hover: none) {
            .suggestion-button {
                padding: 12px;
            }
            
            #message-input {
                font-size: 16px; /* Voorkomt inzoomen op iOS bij focus */
            }
            
            #send-btn {
                min-width: 44px; /* Verbeterde toegankelijkheid voor aanraakdoelen */
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <a href="/" class="back-to-admin">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"></path>
        </svg>
        Terug naar admin
    </a>

    <div id="logo-container" class="bot-logo">
        <!-- Logo wordt dynamisch ingevoegd -->
        <img src="" alt="Bot Logo" id="bot-logo-img">
    </div>

    <div class="chat-container">
        <div class="chat-with-suggestions">
            <div class="chat-main">
                <div class="chat-header">
                    <div class="bot-name" id="botName">Laden...</div>
                    <div class="header-actions">
                        <button class="reset-button" id="reset-btn" title="Start een nieuw gesprek">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                <path d="M3 3v5h5"/>
                            </svg>
                        </button>
        </div>
            </div>
            
                <div class="chat-messages" id="chat-messages">
                    <div class="welcome-image-container" id="welcomeImageContainer">
                        <!-- Welkomstafbeelding wordt dynamisch ingevoegd -->
                    </div>
                    <!-- Berichten worden hier dynamisch toegevoegd -->
                    <div class="typing-indicator" id="typing-indicator">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
        </div>
        
                <div class="chat-input">
                    <textarea 
                        id="message-input" 
                        placeholder="Type je bericht..." 
                        rows="1"
                    ></textarea>
                    <button id="send-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="suggestions-panel" id="suggestions-panel">
                <h3>Veelgestelde vragen</h3>
                <!-- Suggesties worden hier dynamisch toegevoegd -->
            </div>
        </div>
        </div>
        
    <!-- Debug container (optioneel) -->
    <div class="debug-container" id="debug-container">
            <h2>Debug Informatie</h2>
        <div id="console-output" class="console-output"></div>
        <button class="show-debug" id="toggle-debug">Toon Debug Info</button>
    </div>
    
    <!-- Laad onze modules met type="module" -->
    <script type="module">
        // Importeer onze modules
        import { BotpressChatClient, extractWebhookId } from './js/botpress-api.js';
        import { startPollingMessages, stopPollingMessages, logToConsole, showStatus, addMessage, showTyping } from './js/chat-ui.js';
        import { getBotById, getBotStyling, saveChatMessage } from './js/supabase-service.js';
        
        // DOM elementen
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const resetBtn = document.getElementById('reset-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const consoleOutput = document.getElementById('console-output');
        const botNameHeader = document.getElementById('botName');
        const botLogoImg = document.getElementById('bot-logo-img');
        const welcomeImageContainer = document.getElementById('welcomeImageContainer');
        const suggestionsPanel = document.getElementById('suggestions-panel');
        const debugContainer = document.getElementById('debug-container');
        const toggleDebugBtn = document.getElementById('toggle-debug');
        
        // Globale variabelen
        let userId = null;
        let userKey = null;
        let conversationId = null;
        let webhookId = null;
        let client = null;
        let botId = null;
        let lastProcessedMessageIds = new Set();
        let botStyling = null;
        let isProcessing = false;
        
        // Pas de bot styling toe
        function applyBotStyling(styling) {
            if (!styling) {
                logToConsole('Geen styling data ontvangen', 'warning', consoleOutput);
                return;
            }
            
            // Uitgebreide debugging van styling object structuur
            console.log('Toepassen van bot styling data (volledig object):', styling);
            console.log('Styling object type:', typeof styling);
            console.log('Styling object keys:', Object.keys(styling));
            
            // Check of alle benodigde sub-objecten aanwezig zijn
            const hasGeneral = styling.general && typeof styling.general === 'object';
            const hasColors = styling.colors && typeof styling.colors === 'object';
            const hasText = styling.text && typeof styling.text === 'object';
            const hasDimensions = styling.dimensions && typeof styling.dimensions === 'object';
            
            console.log('Styling structuur controle:', {
                hasGeneral: hasGeneral,
                hasColors: hasColors,
                hasText: hasText,
                hasDimensions: hasDimensions
            });
            
            if (!hasGeneral || !hasColors || !hasText || !hasDimensions) {
                console.warn('Waarschuwing: Styling object mist een of meer vereiste sub-objecten');
                logToConsole('Waarschuwing: Styling object mist een of meer vereiste sub-objecten', 'warning', consoleOutput);
            }
            
            logToConsole('Bot styling data ontvangen', 'info', consoleOutput);
            
            // Sla styling op voor later gebruik
            botStyling = styling;
            
            // Direct toepassen van de specifieke afmetingen
            applySpecificBotDimensions(styling);
            
            // Algemene stijl
            if (hasGeneral) {
                console.log('Toepassen general styling:', styling.general);
                
                // Bot titel/naam
                if (styling.general.title) {
                    botNameHeader.textContent = styling.general.title;
                    logToConsole(`Bot titel ingesteld: ${styling.general.title}`, 'info', consoleOutput);
                } else {
                    console.log('Geen titel gevonden in styling.general');
                }
                
                // Font family
                if (styling.general.fontFamily) {
                    document.body.style.fontFamily = styling.general.fontFamily;
                    logToConsole(`Font family ingesteld: ${styling.general.fontFamily}`, 'info', consoleOutput);
                } else {
                    console.log('Geen fontFamily gevonden in styling.general');
                }
                
                // Logo
                if (styling.general.logo) {
                    botLogoImg.src = styling.general.logo;
                    botLogoImg.style.display = 'block';
                    logToConsole(`Logo ingesteld: ${styling.general.logo}`, 'info', consoleOutput);
                } else {
                    console.log('Geen logo gevonden in styling.general');
                    botLogoImg.style.display = 'none';
                }
                
                // Welkomstafbeelding
                if (styling.general.welcomeImage) {
                    welcomeImageContainer.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = styling.general.welcomeImage;
                    img.alt = 'Welkom';
                    welcomeImageContainer.appendChild(img);
                    welcomeImageContainer.classList.remove('hidden');
                    logToConsole(`Welkomstafbeelding ingesteld: ${styling.general.welcomeImage}`, 'info', consoleOutput);
                } else {
                    console.log('Geen welcomeImage gevonden in styling.general');
                    welcomeImageContainer.classList.add('hidden');
                }
            } else {
                logToConsole('Geen general object gevonden in styling data', 'warning', consoleOutput);
                console.warn('Geen general object gevonden in styling data');
            }
            
            // Veelgestelde vragen
            suggestionsPanel.innerHTML = '<h3>Veelgestelde vragen</h3>';
            if (styling.suggestions && Array.isArray(styling.suggestions) && styling.suggestions.length > 0) {
                suggestionsPanel.style.display = 'block';
                
                // Maak een fragment voor betere performance
                const fragment = document.createDocumentFragment();
                
                styling.suggestions.forEach(suggestion => {
                    const button = document.createElement('button');
                    button.className = 'suggestion-button';
                    button.textContent = suggestion;
                    button.onclick = () => {
                        messageInput.value = suggestion;
                        sendUserMessage();
                    };
                    fragment.appendChild(button);
                });
                
                // Voeg alle suggesties in één keer toe aan het panel
                suggestionsPanel.appendChild(fragment);
                
                // Zorg ervoor dat het panel zichtbaar is
                document.querySelector('.chat-with-suggestions').style.flexDirection = 'row';
                logToConsole(`${styling.suggestions.length} suggesties toegevoegd`, 'info', consoleOutput);
            } else {
                // Verberg het panel volledig als er geen suggesties zijn
                suggestionsPanel.style.display = 'none';
                document.querySelector('.chat-with-suggestions').style.flexDirection = 'column';
                document.querySelector('.chat-main').style.width = '100%';
                document.querySelector('.chat-main').style.margin = '0 auto';
                logToConsole('Geen suggesties gevonden, panel verborgen', 'info', consoleOutput);
            }
            
            // Placeholder tekst voor de input
            if (styling.text && styling.text.placeholderText) {
                messageInput.placeholder = styling.text.placeholderText;
                logToConsole(`Placeholder tekst ingesteld: ${styling.text.placeholderText}`, 'info', consoleOutput);
            }
            
            // Dimensies worden al ingesteld door applySpecificBotDimensions
            
            // Kleuren
            if (styling.colors) {
                // CSS variabelen instellen
                document.documentElement.style.setProperty('--primary-color', styling.colors.primary || '#007bff');
                document.documentElement.style.setProperty('--user-bubble', styling.colors.userBubble || '#007bff');
                document.documentElement.style.setProperty('--user-text', styling.colors.userText || '#ffffff');
                document.documentElement.style.setProperty('--bot-bubble', styling.colors.botBubble || '#f8f9fa');
                document.documentElement.style.setProperty('--bot-text', styling.colors.botText || '#212529');
                
                // Headers, chat container, etc.
                const chatHeader = document.querySelector('.chat-header');
                chatHeader.style.backgroundColor = styling.colors.primary || '#007bff';
                
                // Chat title kleur
                if (styling.colors.titleText) {
                    botNameHeader.style.color = styling.colors.titleText;
                } else if (styling.colors.userText) {
                    botNameHeader.style.color = styling.colors.userText;
                }
                
                // Suggesties panel
                if (styling.colors.suggestionsPanelBg) {
                    suggestionsPanel.style.backgroundColor = styling.colors.suggestionsPanelBg;
                }
                
                // Dynamische stylesheet voor kleuroverrides
                // Verwijder eerst bestaande styling elementen die we eerder hebben toegevoegd
                const existingStyles = document.head.querySelectorAll('style[data-styling="bot-custom"]');
                existingStyles.forEach(el => el.remove());
                
                const styleEl = document.createElement('style');
                styleEl.setAttribute('data-styling', 'bot-custom');
                styleEl.textContent = `
                    .message.user {
                        background-color: ${styling.colors.userBubble || '#007bff'};
                        color: ${styling.colors.userText || '#ffffff'};
                    }
                    .message.bot {
                        background-color: ${styling.colors.botBubble || '#f8f9fa'};
                        color: ${styling.colors.botText || '#212529'};
                    }
                    #send-btn {
                        background-color: ${styling.colors.primary || '#007bff'};
                    }
                    .chat-header {
                        background-color: ${styling.colors.primary || '#007bff'};
                        color: ${styling.colors.titleText || styling.colors.userText || '#ffffff'};
                    }
                    .bot-name {
                        color: ${styling.colors.titleText || styling.colors.userText || '#ffffff'};
                    }
                    .suggestion-button {
                        background-color: ${styling.colors.suggestionButtonBg || '#f8f9fa'};
                        color: ${styling.colors.suggestionTextColor || '#212529'};
                        border: 1px solid ${styling.colors.suggestionBorderColor || '#dee2e6'};
                    }
                    .suggestion-button:hover {
                        background-color: ${lightenDarkenColor(styling.colors.suggestionButtonBg || '#f8f9fa', -10)};
                        border-color: ${lightenDarkenColor(styling.colors.suggestionBorderColor || '#dee2e6', -10)};
                    }
                `;
                document.head.appendChild(styleEl);
                
                logToConsole('Kleurenschema toegepast', 'info', consoleOutput);
            }
            
            logToConsole('Bot styling succesvol toegepast', 'success', consoleOutput);
            
            // DIRECT NA HET TOEPASSEN VAN STYLING DE AFMETINGEN FORCEREN
            setTimeout(() => {
                console.log("Forceer afmetingen direct na styling");
                forceCorrectDimensions();
            }, 50);
        }
        
        // Nieuwe functie voor het direct toepassen van specifieke botafmetingen
        function applySpecificBotDimensions(styling) {
            if (!styling || !styling.dimensions) {
                console.log("Geen dimensies gevonden in styling");
                return;
            }
            
            console.log("Direct toepassen van specifieke bot afmetingen:", styling.dimensions);
            
            const chatMain = document.querySelector('.chat-main');
            const chatWithSuggestions = document.querySelector('.chat-with-suggestions');
            const suggestionsPanel = document.getElementById('suggestions-panel');
            const chatContainer = document.querySelector('.chat-container');
            
            // Check of suggesties verborgen moeten worden
            const hideSuggestions = styling.dimensions.showSuggestionsPanel === false || 
                                   !styling.suggestions || 
                                   !Array.isArray(styling.suggestions) || 
                                   styling.suggestions.length === 0;
            
            console.log("Suggesties moeten verborgen worden:", hideSuggestions, "showSuggestionsPanel waarde:", styling.dimensions.showSuggestionsPanel);
            
            // Haal dimensies direct uit de styling
            const chatWidth = styling.dimensions.chatWidth ? parseInt(styling.dimensions.chatWidth) : 400;
            const chatHeight = styling.dimensions.chatHeight ? parseInt(styling.dimensions.chatHeight) : 600;
            
            // Check of we op een mobiel apparaat zijn
            const isMobile = window.innerWidth <= 768;
            const isSmallMobile = window.innerWidth <= 480;
            
            console.log(`Toepassen dimensies: breedte=${chatWidth}px, hoogte=${chatHeight}px, suggesties verborgen=${hideSuggestions}, mobiel=${isMobile}, kleinmobiel=${isSmallMobile}`);
            
            // Verwijder alle bestaande inline styles en stylesheets die afmetingen regelen
            document.querySelectorAll('style[data-dimensions]').forEach(el => el.remove());
            
            // Maak geheel nieuwe stylesheet voor de containers
            const dimStyleEl = document.createElement('style');
            dimStyleEl.setAttribute('data-dimensions', 'bot-custom-fixed');
            
            // Extra krachtige selector voor alle container stylingen
            if (hideSuggestions) {
                // Verberg suggesiepanel compleet
                dimStyleEl.textContent = `
                    /* RESET ALLE LAYOUT PROPERTIES */
                    .chat-with-suggestions, .chat-main, #suggestions-panel {
                        margin: 0 !important;
                        padding: 0 !important;
                        gap: 0 !important;
                        box-sizing: border-box !important;
                    }
                    
                    /* HARDE DIMENSIE FIXES - DESKTOP VERSIE */
                    @media (min-width: 769px) {
                        .chat-main {
                            width: ${chatWidth}px !important;
                            height: ${chatHeight}px !important;
                            min-width: ${chatWidth}px !important;
                            max-width: ${chatWidth}px !important;
                            min-height: ${chatHeight}px !important;
                            max-height: ${chatHeight}px !important;
                            margin: 0 auto !important;
                        }
                        
                        .chat-with-suggestions {
                            flex-direction: column !important;
                            justify-content: center !important;
                            align-items: center !important;
                            display: flex !important;
                            width: 100% !important;
                        }
                    }
                    
                    /* MOBIELE VERSIE */
                    @media (max-width: 768px) {
                        .chat-main {
                            width: 100% !important;
                            max-width: 100% !important;
                            min-width: 0 !important;
                            height: auto !important;
                            min-height: 70vh !important;
                            margin: 0 !important;
                        }
                        
                        .chat-with-suggestions {
                            flex-direction: column !important;
                            width: 100% !important;
                        }
                    }
                    
                    /* VERBERG SUGGESTIES VOLLEDIG */
                    #suggestions-panel {
                        display: none !important;
                        width: 0 !important;
                        height: 0 !important;
                        opacity: 0 !important;
                        visibility: hidden !important;
                        overflow: hidden !important;
                        position: absolute !important;
                        z-index: -9999 !important;
                    }
                `;
            } else {
                // Toon suggesiepanel direct naast chatbox
                dimStyleEl.textContent = `
                    /* RESET ALLE LAYOUT PROPERTIES */
                    .chat-with-suggestions, .chat-main, #suggestions-panel {
                        margin: 0 !important;
                        padding: 0 !important;
                        gap: 0 !important;
                        box-sizing: border-box !important;
                    }
                    
                    /* DESKTOP LAYOUT - NAAST ELKAAR */
                    @media (min-width: 769px) {
                        .chat-with-suggestions {
                            display: flex !important;
                            flex-direction: row !important;
                            align-items: start !important;
                            justify-content: center !important;
                            gap: 10px !important;
                            width: ${chatWidth + 300 + 10}px !important;
                            margin: 0 auto !important;
                        }
                        
                        .chat-main {
                            width: ${chatWidth}px !important;
                            height: ${chatHeight}px !important;
                            min-width: ${chatWidth}px !important;
                            max-width: ${chatWidth}px !important;
                            min-height: ${chatHeight}px !important;
                            max-height: ${chatHeight}px !important;
                            margin: 0 !important;
                        }
                        
                        #suggestions-panel {
                            width: 300px !important;
                            min-width: 300px !important;
                            max-width: 300px !important;
                            height: auto !important;
                            max-height: none !important;
                            margin: 0 !important;
                            padding: 18px !important;
                            overflow-y: visible !important;
                        }
                    }
                    
                    /* MOBIELE LAYOUT - ONDER ELKAAR */
                    @media (max-width: 768px) {
                        .chat-with-suggestions {
                            flex-direction: column !important;
                            width: 100% !important;
                            gap: 10px !important;
                        }
                        
                        .chat-main {
                            width: 100% !important;
                            max-width: 100% !important;
                            min-width: 0 !important;
                            height: auto !important;
                            min-height: 60vh !important;
                            margin: 0 0 10px 0 !important;
                        }
                        
                        #suggestions-panel {
                            width: 100% !important;
                            max-width: 100% !important;
                            min-width: 0 !important;
                            margin: 0 !important;
                            padding: 15px !important;
                            height: auto !important;
                            max-height: none !important;
                        }
                    }
                    
                    /* KLEINE MOBIELE SCHERMEN */
                    @media (max-width: 480px) {
                        .chat-main {
                            min-height: 70vh !important;
                        }
                        
                        #suggestions-panel {
                            padding: 12px !important;
                        }
                    }
                `;
            }
            
            document.head.appendChild(dimStyleEl);
            
            // DIRECTE DOM MANIPULATIE
            // Verwijder alle inline stijlen eerst
            chatMain.removeAttribute('style');
            chatWithSuggestions.removeAttribute('style');
            suggestionsPanel.removeAttribute('style');
            
            // Stijlen worden nu via de stylesheet toegepast zodat media queries kunnen werken
            
            // Pas border radius toe indien ingesteld
            if (styling.dimensions.borderRadius) {
                const borderRadius = styling.dimensions.borderRadius;
                const chatHeader = document.querySelector('.chat-header');
                const chatInput = document.querySelector('.chat-input');
                
                chatMain.style.borderRadius = `${borderRadius}px`;
                chatHeader.style.borderRadius = `${borderRadius}px ${borderRadius}px 0 0`;
                chatInput.style.borderRadius = `0 0 ${borderRadius}px ${borderRadius}px`;
                if (!hideSuggestions) {
                    suggestionsPanel.style.borderRadius = `${borderRadius}px`;
                }
            }
            
            // Voeg event listener toe om dimensies aan te passen bij venstergroottewijzigingen
            window.removeEventListener('resize', handleResize);
            window.addEventListener('resize', handleResize);
            
            function handleResize() {
                // Na wijziging van venstergrootte, pas de stijlen opnieuw toe
                console.log("Venstergrootte gewijzigd, dimensies worden aangepast");
                
                // Verwijder de huidige stylesheet en maak een nieuwe
                document.querySelectorAll('style[data-dimensions="bot-custom-fixed"]').forEach(el => el.remove());
                applySpecificBotDimensions(styling);
            }
            
            console.log("Specifieke bot dimensies strikt toegepast - suggesties verborgen: " + hideSuggestions);
        }
        
        // DIRECTE FIX VOOR AFMETINGEN PROBLEEM - bijgewerkt
        function forceCorrectDimensions() {
            console.log("FORCEER CORRECTE AFMETINGEN UITVOEREN");
            
            // Altijd de specifieke afmetingen toepassen als beschikbaar
            if (botStyling && botStyling.dimensions) {
                applySpecificBotDimensions(botStyling);
                console.log("Specifieke afmetingen opnieuw toegepast");
                return;
            }
            
            // Als geen styling beschikbaar, gebruik standaard afmetingen
            const chat = document.querySelector('.chat-main');
            const chatWithSuggestions = document.querySelector('.chat-with-suggestions');
            const suggestionsPanel = document.getElementById('suggestions-panel');
            
            // Check of suggesties panel zichtbaar is
            const isSuggestionsPanelVisible = suggestionsPanel && 
                (window.getComputedStyle(suggestionsPanel).display !== 'none');
            
            console.log("Suggestiepanel zichtbaar:", isSuggestionsPanelVisible);
            
            if (!isSuggestionsPanelVisible) {
                // Als geen suggesties, centreer de chat
                chatWithSuggestions.style.flexDirection = 'column';
                chatWithSuggestions.style.alignItems = 'center';
                chat.style.margin = '0 auto';
                chat.style.width = '400px';
                chat.style.maxWidth = '100%';
            } else {
                // Als suggesties zichtbaar, toon naast elkaar
                if (window.innerWidth >= 1024) {
                    chatWithSuggestions.style.flexDirection = 'row';
                    chat.style.margin = '0 20px 0 0';
                    chat.style.width = '400px';
                }
            }
        }
        
        // Debug functionaliteit
        if (toggleDebugBtn) {
            toggleDebugBtn.addEventListener('click', () => {
                if (debugContainer.classList.contains('visible')) {
                    debugContainer.classList.remove('visible');
                    toggleDebugBtn.textContent = 'Toon Debug Info';
                } else {
                    debugContainer.classList.add('visible');
                    toggleDebugBtn.textContent = 'Verberg Debug Info';
                }
            });
        }
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = '40px';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // URL parameters verwerken en chat initialiseren
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Debug informatie over wat er in localStorage staat
                console.log('--- Informatie uit localStorage bij laden: ---');
                console.log('botId:', localStorage.getItem('botId'));
                console.log('botName:', localStorage.getItem('botName'));
                console.log('currentWebhookId:', localStorage.getItem('currentWebhookId'));
                console.log('webhookId:', localStorage.getItem('webhookId'));
                console.log('userId:', localStorage.getItem('userId'));
                console.log('userKey:', localStorage.getItem('userKey'));
                console.log('conversationId:', localStorage.getItem('conversationId'));
                console.log('-------------------------------------------');
                
                // Toon deze informatie ook in debug log
                logToConsole('localStorage botId: ' + localStorage.getItem('botId'), 'info', consoleOutput);
                logToConsole('localStorage botName: ' + localStorage.getItem('botName'), 'info', consoleOutput);
                logToConsole('localStorage webhookId: ' + localStorage.getItem('currentWebhookId'), 'info', consoleOutput);
                
                // Alleen op desktop een debug-knop toevoegen
                const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (!isMobile) {
                    const toggleDebugButton = document.createElement('button');
                    toggleDebugButton.textContent = 'Toon Debug Info';
                    toggleDebugButton.style.position = 'fixed';
                    toggleDebugButton.style.top = '20px';
                    toggleDebugButton.style.right = '20px';
                    toggleDebugButton.style.zIndex = '1000';
                    toggleDebugButton.className = 'show-debug';
                    toggleDebugButton.addEventListener('click', () => {
                        debugContainer.classList.toggle('visible');
                        toggleDebugButton.textContent = debugContainer.classList.contains('visible') ? 
                            'Verberg Debug Info' : 'Toon Debug Info';
                    });
                    document.body.appendChild(toggleDebugButton);
                }
                
                // Haal de bot ID uit de URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                botId = urlParams.get('bot');
                
                if (botId) {
                    // Haal bot informatie op uit Supabase
                    const bot = await getBotById(botId);
                    if (bot) {
                        // Vul de webhook ID in
                        webhookId = extractWebhookId(bot.webhook_id);
                        
                        // Vul de bot naam in
                        botNameHeader.textContent = `Chat met ${bot.name}`;
                        
                        // Sla de bot gegevens op in localStorage voor latere sessies
                        localStorage.setItem('botId', bot.id);
                        localStorage.setItem('botName', bot.name);
                        localStorage.setItem('currentWebhookId', bot.webhook_id);
                        
                        // Haal styling op en pas toe
                        const styling = await getBotStyling(botId);
                        if (styling) {
                            applyBotStyling(styling);
                        } else {
                            logToConsole('Geen styling gevonden voor bot ' + botId, 'info', consoleOutput);
                        }
                        
                        // Start de chat automatisch
                        await initializeChat();
                    } else {
                        logToConsole(`Geen bot gevonden met ID: ${botId}`, 'error', consoleOutput);
                    }
                } else {
                    // Haal de bot ID uit localStorage als fallback
                    botId = localStorage.getItem('botId');
                    if (botId) {
                        logToConsole('Bot ID uit localStorage gebruikt: ' + botId, 'info', consoleOutput);
                        
                        // Haal de webhook ID uit localStorage
                        webhookId = extractWebhookId(localStorage.getItem('currentWebhookId'));
                        
                        // Toon de bot naam
                        const botName = localStorage.getItem('botName');
                        if (botName) {
                            botNameHeader.textContent = `Chat met ${botName}`;
                        }
                        
                        // Haal styling op en pas toe
                        const styling = await getBotStyling(botId);
                        if (styling) {
                            applyBotStyling(styling);
                        } else {
                            logToConsole('Geen styling gevonden voor bot ' + botId, 'info', consoleOutput);
                        }
                        
                        if (webhookId) {
                            logToConsole('Webhook ID uit localStorage gebruikt: ' + webhookId, 'info', consoleOutput);
                            await initializeChat();
                        } else {
                            logToConsole('Geen webhook ID gevonden in localStorage', 'error', consoleOutput);
                        }
                    } else {
                        // Haal de webhook ID uit localStorage als fallback
                        webhookId = extractWebhookId(localStorage.getItem('currentWebhookId'));
                        if (webhookId) {
                            logToConsole('Webhook ID uit localStorage gebruikt: ' + webhookId, 'info', consoleOutput);
                            await initializeChat();
                        } else {
                            logToConsole('Geen webhook ID gevonden', 'error', consoleOutput);
                        }
                    }
                }
            } catch (error) {
                logToConsole(`Fout bij laden bot gegevens: ${error.message}`, 'error', consoleOutput);
            }
        });
        
        // Event listeners
        sendBtn.addEventListener('click', sendUserMessage);
        resetBtn.addEventListener('click', resetChat);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendUserMessage();
            }
        });
        
        // Initialisatie
        logToConsole('Chat client geladen. Klaar om te beginnen.', 'info', consoleOutput);
        
        // Initialiseer de chat
        async function initializeChat() {
            try {
                logToConsole('Chat initialiseren...', 'info', consoleOutput);
                
                if (!webhookId) {
                    logToConsole('Geen webhook ID beschikbaar', 'error', consoleOutput);
                    return false;
                }
                
                // Creëer een nieuwe client
                client = new BotpressChatClient({
                    webhookId: webhookId
                });
                
                try {
                    // Test de verbinding
                    await client.checkConnection();
                    logToConsole('Verbinding met Botpress API succesvol', 'success', consoleOutput);
                } catch (connectionError) {
                    logToConsole(`Verbindingsfout: ${connectionError.message}`, 'error', consoleOutput);
                    console.error('Verbindingsfout:', connectionError);
                    addMessage('Er is een fout opgetreden bij het verbinden met de chat service. Probeer het later opnieuw.', false, chatMessages);
                    return false;
                }
                
                try {
                    // Maak een gebruiker aan
                    const userResult = await client.createUser({
                        name: `User-${Date.now()}`,
                        tags: { source: 'web-client' }
                    });
                    
                    userId = userResult.user.id;
                    userKey = userResult.key;
                    
                    // Sla deze op in localStorage voor later gebruik
                    localStorage.setItem('userId', userId);
                    localStorage.setItem('userKey', userKey);
                    
                    logToConsole(`Gebruiker aangemaakt met ID: ${userId}`, 'success', consoleOutput);
                } catch (userError) {
                    logToConsole(`Fout bij aanmaken gebruiker: ${userError.message}`, 'error', consoleOutput);
                    console.error('Fout bij aanmaken gebruiker:', userError);
                    addMessage('Er is een fout opgetreden bij het aanmaken van een gebruiker. Probeer het later opnieuw.', false, chatMessages);
                    return false;
                }
                
                try {
                    // Maak een conversatie aan
                    const conversation = await client.createConversation({
                        userId,
                        userKey
                    });
                    
                    conversationId = conversation.id;
                    // Sla deze op in localStorage voor later gebruik
                    localStorage.setItem('conversationId', conversationId);
                    
                    logToConsole(`Conversatie aangemaakt met ID: ${conversationId}`, 'success', consoleOutput);
                } catch (convError) {
                    logToConsole(`Fout bij aanmaken conversatie: ${convError.message}`, 'error', consoleOutput);
                    console.error('Fout bij aanmaken conversatie:', convError);
                    addMessage('Er is een fout opgetreden bij het aanmaken van de chat. Probeer het later opnieuw.', false, chatMessages);
                    return false;
                }
                
                // Start polling voor berichten met de juiste parameters
                startPollingMessages(client, userId, userKey, conversationId, lastProcessedMessageIds, chatMessages, consoleOutput);
                
                // Focus op invoerveld
                messageInput.focus();
                
                // Zorg ervoor dat de welkomstafbeelding zichtbaar is
                const welcomeContainer = document.getElementById('welcomeImageContainer');
                if (welcomeContainer) {
                    welcomeContainer.classList.remove('hidden');
                }
                
                // DIRECT NA INITIALISATIE DE AFMETINGEN FORCEREN
                setTimeout(() => {
                    console.log("Forceer afmetingen na chat initialisatie");
                    forceCorrectDimensions();
                }, 100);
                
                return true;
            } catch (error) {
                logToConsole(`Fout bij initialiseren chat: ${error.message}`, 'error', consoleOutput);
                console.error('Algemene fout bij initialiseren chat:', error);
                addMessage('Er is een fout opgetreden bij het initialiseren van de chat. Probeer het later opnieuw.', false, chatMessages);
                return false;
            }
        }
        
        // Stuur een gebruikersbericht
        async function sendUserMessage() {
            const text = messageInput.value.trim();
            if (!text || isProcessing) return;
            
            isProcessing = true;
            
            // Wis invoerveld
            messageInput.value = '';
            messageInput.style.height = '40px';
            
            // Voeg bericht toe aan chat
            addMessage(text, true, chatMessages);
            
            // Toon typing indicator
            showTyping(true, typingIndicator);
            
            try {
                logToConsole(`Bericht versturen: ${text}`, 'info', consoleOutput);
                const messageResult = await client.sendMessage({
                    userId,
                    userKey,
                    conversationId,
                    payload: {
                        type: 'text',
                        text
                    }
                });
                
                logToConsole(`Bericht verzonden met ID: ${messageResult.id}`, 'success', consoleOutput);
                
                // Verberg de welkomstafbeelding bij het eerste bericht
                welcomeImageContainer.classList.add('hidden');
                
                // Reset isProcessing zodat volgende berichten kunnen worden verzonden
                isProcessing = false;
            } catch (error) {
                logToConsole(`Fout bij versturen bericht: ${error.message}`, 'error', consoleOutput);
                showTyping(false, typingIndicator);
                addMessage('Er is een fout opgetreden bij het versturen van je bericht.', false, chatMessages);
                isProcessing = false;
            }
        }
        
        // Reset de chat
        async function resetChat() {
            if (!client || !userId || !userKey || !conversationId) return;
            
            try {
                // Stop polling
                stopPollingMessages();
                
                logToConsole('Chat resetten...', 'info', consoleOutput);
                
                // Verwijder de huidige conversatie
                await client.deleteConversation({
                    userId,
                    userKey,
                    conversationId
                });
                
                logToConsole('Vorige conversatie verwijderd', 'success', consoleOutput);
                
                // Wis berichten
                while (chatMessages.firstChild) {
                    if (chatMessages.firstChild === typingIndicator) {
                        break;
                    }
                    chatMessages.removeChild(chatMessages.firstChild);
                }
                
                // Reset verwerkte berichten lijst
                lastProcessedMessageIds = new Set();
                
                // Maak een nieuwe conversatie aan
                const conversation = await client.createConversation({
                    userId,
                    userKey
                });
                
                conversationId = conversation.id;
                logToConsole(`Nieuwe conversatie aangemaakt: ${conversationId}`, 'success', consoleOutput);
                
                // Reset welkomstafbeelding als die er is
                if (botStyling && botStyling.general && botStyling.general.welcomeImage) {
                    welcomeImageContainer.classList.remove('hidden');
                }
                
                // Start polling opnieuw
                startPollingMessages(client, userId, userKey, conversationId, lastProcessedMessageIds, chatMessages, consoleOutput);
                
                // Voeg welkomstbericht toe (lokaal)
                addMessage('Hallo! Hoe kan ik je helpen?', false, chatMessages);
                
                isProcessing = false;
                
                // FORCEER AFMETINGEN NA RESET
                setTimeout(() => {
                    console.log("Forceer afmetingen na chat reset");
                    forceCorrectDimensions();
                }, 100);
            } catch (error) {
                logToConsole(`Fout bij herstarten chat: ${error.message}`, 'error', consoleOutput);
            }
        }
        
        // TOEGEVOEGD: Functie voor kleurhulp - was eerder gedefinieerd maar niet gevonden
        function lightenDarkenColor(color, amount) {
            let usePound = false;
            
            if (color[0] === "#") {
                color = color.slice(1);
                usePound = true;
            }
            
            const num = parseInt(color, 16);
            
            let r = (num >> 16) + amount;
            r = Math.max(Math.min(255, r), 0);
            
            let g = ((num >> 8) & 0x00FF) + amount;
            g = Math.max(Math.min(255, g), 0);
            
            let b = (num & 0x0000FF) + amount;
            b = Math.max(Math.min(255, b), 0);
            
            return (usePound ? "#" : "") + (g | (r << 8) | (b << 16)).toString(16).padStart(6, "0");
        }
    </script>
</body>
</html> 